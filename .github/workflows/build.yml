name: PlatformIO CI - Build ESP32 Firmware

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Cache pip
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Cache PlatformIO
      uses: actions/cache@v3
      with:
        path: ~/.platformio
        key: ${{ runner.os }}-${{ hashFiles('**/lockfiles') }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade platformio
    
    - name: Build PlatformIO Project
      run: pio run
    
    - name: List build outputs
      run: |
        echo "=== Build output files ==="
        ls -lah .pio/build/esp32dev/
    
    - name: Prepare binary files
      run: |
        mkdir -p firmware
        cp .pio/build/esp32dev/firmware.bin firmware/firmware.bin
        cp .pio/build/esp32dev/bootloader.bin firmware/bootloader.bin || echo "Bootloader not found"
        cp .pio/build/esp32dev/partitions.bin firmware/partitions.bin || echo "Partitions not found"
        
        # Get bootloader and partitions from framework if not in build
        if [ ! -f firmware/bootloader.bin ]; then
          find ~/.platformio/packages/framework-arduinoespressif32/tools/sdk/esp32/bin/ -name "bootloader_dio_40m.bin" -exec cp {} firmware/bootloader.bin \;
        fi
        
        if [ ! -f firmware/partitions.bin ]; then
          find ~/.platformio/packages/framework-arduinoespressif32/tools/partitions/ -name "default.bin" -exec cp {} firmware/partitions.bin \;
        fi
        
        ls -lah firmware/
    
    - name: Create flash script
      run: |
        cat > firmware/flash.sh << 'EOF'
        #!/bin/bash
        # Flash script for ESP32
        # Usage: ./flash.sh [PORT]
        # Example: ./flash.sh /dev/ttyUSB0
        
        PORT=${1:-/dev/ttyUSB0}
        
        echo "Flashing ESP32 on port: $PORT"
        echo "Make sure esptool.py is installed: pip install esptool"
        
        esptool.py --chip esp32 --port $PORT --baud 921600 \
          --before default_reset --after hard_reset write_flash -z \
          --flash_mode dio --flash_freq 40m --flash_size detect \
          0x1000 bootloader.bin \
          0x8000 partitions.bin \
          0x10000 firmware.bin
        
        echo "Flashing complete!"
        EOF
        
        chmod +x firmware/flash.sh
        
        cat > firmware/flash.bat << 'EOF'
        @echo off
        REM Flash script for ESP32 on Windows
        REM Usage: flash.bat [PORT]
        REM Example: flash.bat COM3
        
        set PORT=%1
        if "%PORT%"=="" set PORT=COM3
        
        echo Flashing ESP32 on port: %PORT%
        echo Make sure esptool.py is installed: pip install esptool
        
        esptool.py --chip esp32 --port %PORT% --baud 921600 ^
          --before default_reset --after hard_reset write_flash -z ^
          --flash_mode dio --flash_freq 40m --flash_size detect ^
          0x1000 bootloader.bin ^
          0x8000 partitions.bin ^
          0x10000 firmware.bin
        
        echo Flashing complete!
        pause
        EOF
    
    - name: Create README for firmware
      run: |
        cat > firmware/README.md << 'EOF'
        # ESP32 Firmware Files
        
        ## الملفات
        
        - `firmware.bin` - الملف الرئيسي للبرنامج
        - `bootloader.bin` - ملف الـ bootloader
        - `partitions.bin` - جدول التقسيمات
        - `flash.sh` - سكريبت رفع الملفات (Linux/Mac)
        - `flash.bat` - سكريبت رفع الملفات (Windows)
        
        ## طريقة الرفع
        
        ### Linux/Mac:
        ```bash
        chmod +x flash.sh
        ./flash.sh /dev/ttyUSB0
        ```
        
        ### Windows:
        ```cmd
        flash.bat COM3
        ```
        
        ### يدوياً باستخدام esptool:
        ```bash
        pip install esptool
        
        esptool.py --chip esp32 --port /dev/ttyUSB0 --baud 921600 \
          --before default_reset --after hard_reset write_flash -z \
          --flash_mode dio --flash_freq 40m --flash_size detect \
          0x1000 bootloader.bin \
          0x8000 partitions.bin \
          0x10000 firmware.bin
        ```
        
        ## ملاحظات
        
        - تأكد من توصيل ESP32 بالحاسوب عبر USB
        - قم بتثبيت driver CH340/CP2102 إذا لزم الأمر
        - حدد المنفذ الصحيح (COM3, /dev/ttyUSB0, إلخ)
        EOF
    
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v3
      with:
        name: esp32-firmware
        path: firmware/
        retention-days: 90
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          firmware/firmware.bin
          firmware/bootloader.bin
          firmware/partitions.bin
          firmware/flash.sh
          firmware/flash.bat
          firmware/README.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
