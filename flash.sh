#!/bin/bash

# ุณูุฑูุจุช ููุงุด ูุดุฑูุน bara ESP32
# ูููู ุจููุงุด ูููุงุช BIN ุนูู ESP32

# ุฃููุงู ููุฑุณุงุฆู
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # ุจุฏูู ููู

echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}โ       ุณูุฑูุจุช ููุงุด bara ESP32 WiFi Scanner            โ${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

# ุงูุชุญูู ูู ูุฌูุฏ ูุฌูุฏ firmware
if [ ! -d "firmware" ]; then
    echo -e "${RED}โ ุฎุทุฃ: ูุฌูุฏ firmware ุบูุฑ ููุฌูุฏ!${NC}"
    echo -e "${YELLOW}ุงูุฑุฌุงุก ุชุดุบูู: ./build.sh ุฃููุงู${NC}"
    exit 1
fi

# ุงูุชุญูู ูู ูุฌูุฏ ุงููููุงุช
FILES_MISSING=0
if [ ! -f "firmware/bootloader.bin" ]; then
    echo -e "${RED}โ ููู bootloader.bin ุบูุฑ ููุฌูุฏ${NC}"
    FILES_MISSING=1
fi
if [ ! -f "firmware/partitions.bin" ]; then
    echo -e "${RED}โ ููู partitions.bin ุบูุฑ ููุฌูุฏ${NC}"
    FILES_MISSING=1
fi
if [ ! -f "firmware/firmware.bin" ]; then
    echo -e "${RED}โ ููู firmware.bin ุบูุฑ ููุฌูุฏ${NC}"
    FILES_MISSING=1
fi

if [ $FILES_MISSING -eq 1 ]; then
    echo -e "${YELLOW}ุงูุฑุฌุงุก ุชุดุบูู: ./build.sh ุฃููุงู${NC}"
    exit 1
fi

# ุชุญุฏูุฏ ุงููููุฐ
if [ -z "$1" ]; then
    echo -e "${YELLOW}โ ูู ูุชู ุชุญุฏูุฏ ุงููููุฐ!${NC}"
    echo ""
    echo -e "${BLUE}ุงูููุงูุฐ ุงููุชุงุญุฉ:${NC}"
    ls /dev/tty{USB,ACM}* 2>/dev/null || echo -e "${YELLOW}ูู ูุชู ุงูุนุซูุฑ ุนูู ุฃุฌูุฒุฉ ูุชุตูุฉ${NC}"
    echo ""
    echo -e "${YELLOW}ุงูุงุณุชุฎุฏุงู: ./flash.sh [PORT]${NC}"
    echo -e "${YELLOW}ูุซุงู: ./flash.sh /dev/ttyUSB0${NC}"
    exit 1
fi

PORT=$1

# ุงูุชุญูู ูู ูุฌูุฏ esptool
if ! command -v esptool.py &> /dev/null; then
    echo -e "${YELLOW}โ esptool ุบูุฑ ูุซุจุช!${NC}"
    echo -e "${BLUE}ุฌุงุฑู ุงูุชุซุจูุช...${NC}"
    pip3 install esptool
fi

echo -e "${BLUE}๐ก ุงููููุฐ: $PORT${NC}"
echo -e "${BLUE}โณ ุฌุงุฑู ุงูููุงุด...${NC}"
echo ""

# ููุงุด ุงููููุงุช
esptool.py --chip esp32 --port "$PORT" --baud 921600 \
    --before default_reset --after hard_reset write_flash \
    -z --flash_mode dio --flash_freq 40m --flash_size detect \
    0x1000 firmware/bootloader.bin \
    0x8000 firmware/partitions.bin \
    0x10000 firmware/firmware.bin

if [ $? -eq 0 ]; then
    echo ""
    echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${GREEN}โ           โ ุงูุชูู ุงูููุงุด ุจูุฌุงุญ!                      โ${NC}"
    echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    echo -e "${BLUE}๐ ESP32 ุฌุงูุฒ ุงูุขู!${NC}"
    echo ""
    echo -e "${YELLOW}๐ฑ ุฎุทูุงุช ุงูุชุดุบูู:${NC}"
    echo -e "   1. ุฃุนุฏ ุชุดุบูู ESP32"
    echo -e "   2. ุงูุชุญ Serial Monitor ุนูู: 115200 baud"
    echo -e "   3. ุงุชุตู ุจุดุจูุฉ WiFi: bara"
    echo -e "   4. ุงูุชุญ ุงููุชุตูุญ: 192.168.4.1"
    echo ""
else
    echo ""
    echo -e "${RED}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${RED}โ              โ ูุดู ุงูููุงุด!                           โ${NC}"
    echo -e "${RED}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    echo -e "${YELLOW}ูุตุงุฆุญ ูุญู ุงููุดููุฉ:${NC}"
    echo -e "   1. ุชุฃูุฏ ูู ุชูุตูู ESP32 ุจุงูููุจููุชุฑ"
    echo -e "   2. ุชุฃูุฏ ูู ุตุญุฉ ุงููููุฐ: $PORT"
    echo -e "   3. ุงุถุบุท ุนูู ุฒุฑ BOOT ูู ESP32 ุฃุซูุงุก ุงูููุงุด"
    echo -e "   4. ุฌุฑุจ ูููุฐ USB ุขุฎุฑ"
    echo -e "   5. ุชุญูู ูู ุงูุชุนุฑููุงุช (drivers)"
    echo ""
    exit 1
fi
